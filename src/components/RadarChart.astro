---
interface Props {
  category: {
    name: string;
    items: Array<{ name: string; score: number }>;
  };
  color: string;
}

const { category, color } = Astro.props;

// SVG dimensions
const WIDTH = 280;
const HEIGHT = 240;
const CENTER_X = 140;
const CENTER_Y = 120;
const MAX_RADIUS = 70;

// Calculate polar coordinates for data points
const items = category.items;
const angleStep = (2 * Math.PI) / items.length;

// Generate polygon points
const dataPoints = items.map((item, i) => {
  const angle = (i * angleStep) - (Math.PI / 2); // Start at top
  const normalizedScore = item.score / 100;
  const radius = normalizedScore * MAX_RADIUS;

  const x = CENTER_X + (radius * Math.cos(angle));
  const y = CENTER_Y + (radius * Math.sin(angle));

  return { x, y };
});

const polygonPoints = dataPoints.map(p => `${p.x},${p.y}`).join(' ');

// Generate label positions (slightly outside the max radius)
const LABEL_RADIUS = MAX_RADIUS + 20;
const labelPositions = items.map((item, i) => {
  const angle = (i * angleStep) - (Math.PI / 2);
  const x = CENTER_X + (LABEL_RADIUS * Math.cos(angle));
  const y = CENTER_Y + (LABEL_RADIUS * Math.sin(angle));

  // Determine text anchor based on position
  let textAnchor = 'middle';
  if (x < CENTER_X - 5) textAnchor = 'end';
  else if (x > CENTER_X + 5) textAnchor = 'start';

  return { x, y, textAnchor, name: item.name };
});

// Generate axis line endpoints (from center to max radius)
const axisLines = items.map((_, i) => {
  const angle = (i * angleStep) - (Math.PI / 2);
  const x = CENTER_X + (MAX_RADIUS * Math.cos(angle));
  const y = CENTER_Y + (MAX_RADIUS * Math.sin(angle));

  return { x, y };
});

// Grid circles (5 levels: 20, 40, 60, 80, 100)
const gridLevels = [0.2, 0.4, 0.6, 0.8, 1.0];
---

<div
  class="flex flex-col items-center gap-4 flex-shrink-0 snap-center"
  style={`width: ${WIDTH}px; min-width: ${WIDTH}px; flex-basis: ${WIDTH}px;`}
>
  <div class="relative w-full" style={`height: ${HEIGHT}px;`}>
    <svg
      width={WIDTH}
      height={HEIGHT}
      viewBox={`0 0 ${WIDTH} ${HEIGHT}`}
      class="w-full h-full"
      role="img"
      aria-label={`${category.name} skill radar chart`}
    >
      <title>{category.name} Skills</title>

      <!-- Background grid circles -->
      <g stroke="currentColor" stroke-opacity="0.2" fill="none">
        {gridLevels.map((level) => (
          <circle
            cx={CENTER_X}
            cy={CENTER_Y}
            r={MAX_RADIUS * level}
            stroke-width="1"
          />
        ))}
      </g>

      <!-- Radial axis lines -->
      <g stroke="currentColor" stroke-opacity="0.2">
        {axisLines.map((line) => (
          <line
            x1={CENTER_X}
            y1={CENTER_Y}
            x2={line.x}
            y2={line.y}
            stroke-width="1"
          />
        ))}
      </g>

      <!-- Data polygon -->
      <polygon
        points={polygonPoints}
        fill={color}
        fill-opacity="0.3"
        stroke={color}
        stroke-width="2"
      />

      <!-- Axis labels -->
      <g
        fill="currentColor"
        font-family="Eurostile, sans-serif"
        font-size="12"
        letter-spacing="0.08em"
      >
        {labelPositions.map((label) => (
          <text
            x={label.x}
            y={label.y}
            text-anchor={label.textAnchor}
            dominant-baseline="middle"
          >
            {label.name}
          </text>
        ))}
      </g>
    </svg>

    <!-- Category title -->
    <h3
      class="pointer-events-none absolute left-1/2 top-4 -translate-x-1/2 font-futura text-base sm:text-lg uppercase tracking-[0.2em]"
    >
      {category.name}
    </h3>
  </div>
</div>
